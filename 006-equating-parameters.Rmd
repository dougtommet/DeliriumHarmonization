## Item equating
Using the SNSequate package to equate item parameters.


```{r}
drs.par.dich <- readModels("cfa-drs-2.out")$parameters$unstandardized

drs.par.dich <- drs.par.dich %>%
      filter(paramHeader=="F.BY" | 
           paramHeader=="Thresholds") %>%
    mutate(est = as.numeric(est),
           item = ifelse(paramHeader=="Thresholds", 
                        str_split_fixed(param, "\\$1", 2), param),
           parameter = ifelse(paramHeader=="Thresholds", "T", "FL")) %>%
    select(parameter, item, est) %>%
    mutate_all(funs(tolower))
  drs.par.dich <- drs.par.dich[1:26,1:3]
  drs.par.dich$est <- as.numeric(drs.par.dich$est)
  
drs.par.dich <- drs.par.dich %>% 
  spread(parameter, est) %>%
  mutate(B.drs = t/fl,
         A.drs = fl,
         C.drs = 0,
         itemnum = row_number()) %>%
  select(item, itemnum, A.drs, B.drs, C.drs)
      

mdas.par.dich <- readModels("cfa-mdas-2.out")$parameters$unstandardized

mdas.par.dich <- mdas.par.dich %>%
      filter(paramHeader=="F.BY" | 
           paramHeader=="Thresholds") %>%
    mutate(est = as.numeric(est),
           item = ifelse(paramHeader=="Thresholds", 
                        str_split_fixed(param, "\\$1", 2), param),
           parameter = ifelse(paramHeader=="Thresholds", "T", "FL")) %>%
    select(parameter, item, est) %>%
    mutate_all(funs(tolower))
  mdas.par.dich <- mdas.par.dich[1:20,1:3]
  mdas.par.dich$est <- as.numeric(mdas.par.dich$est)
  
mdas.par.dich <- mdas.par.dich %>% 
  spread(parameter, est) %>%
  mutate(B.mdas = t/fl,
         A.mdas = fl,
         C.mdas = 0) %>%
  select(item, A.mdas, B.mdas, C.mdas)
mdas.par.dich$itemnum <- c(14, 9, 11, 16, 17, 18, 2, 3, 21, 1)


cam.par.dich <- readModels("cfa-cam-2.out")$parameters$unstandardized

cam.par.dich <- cam.par.dich %>%
      filter(paramHeader=="F.BY" | 
           paramHeader=="Thresholds") %>%
    mutate(est = as.numeric(est),
           item = ifelse(paramHeader=="Thresholds", 
                        str_split_fixed(param, "\\$1", 2), param),
           parameter = ifelse(paramHeader=="Thresholds", "T", "FL")) %>%
    select(parameter, item, est) %>%
    mutate_all(funs(tolower))
  cam.par.dich <- cam.par.dich[1:20,1:3]
  cam.par.dich$est <- as.numeric(cam.par.dich$est)
  
cam.par.dich <- cam.par.dich %>% 
  spread(parameter, est) %>%
  mutate(B.cam = t/fl,
         A.cam = fl,
         C.cam = 0,
         itemnum = row_number()) %>%
  select(item, itemnum, A.cam, B.cam, C.cam)
cam.par.dich$itemnum <- c(22, 10, 24, 25, 9, 26, 2, 7, 8, 1)
                     
```
### DRS item parameters
```{r}
drs.par.dich %>%
  select(-C.drs, -itemnum) %>%
  arrange(desc(A.drs)) %>%
  kable(digits=2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center")
```

### MDAS item parameters
```{r}
mdas.par.dich %>%
  select(-C.mdas, -itemnum) %>%
  arrange(desc(A.mdas)) %>%
  kable(digits=2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center")
```

### CAM-S item parameters
```{r}
cam.par.dich %>%
  select(-C.cam, -itemnum) %>%
  arrange(desc(A.cam)) %>%
  kable(digits=2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center")

```


The items used to link the MDAS to the DRS are: Disorientation, Perceptual disturbance, Sleep/wake cycle disturbance, Short term memory impairment, and Delusions.

The items used to link the CAM-S to the DRS are: Disorientation, Perceptual disturbance, Sleep/wake cycle disturbance, Psychomotor agitation, Psychomotor retardation, and Attention.

```{r}
par.drs.mdas <- full_join(drs.par.dich, mdas.par.dich, by = "itemnum") %>%
  select(A.drs, B.drs, C.drs, A.mdas, B.mdas, C.mdas)

comitems <- c(1, 2, 3, 9, 11)
link.drs.mdas <- irt.link(par.drs.mdas, comitems, model = "3PL", 
         icc = "logistic", D = 1.7)  

A.link.mdas <- link.drs.mdas$Haebara[1]
B.link.mdas <- link.drs.mdas$Haebara[2]

mdas.par.dich <- mdas.par.dich %>%
  mutate(A.l.mdas = A.link.mdas*A.mdas,
         B.l.mdas = (B.mdas - B.link.mdas)/A.link.mdas,
         fl.l.mdas = A.l.mdas,
         t.l.mdas = B.l.mdas*fl.l.mdas)
```

### MDAS item parameters linked
```{r}
mdas.par.dich %>%
  select(item, A.mdas, B.mdas, A.l.mdas, B.l.mdas) %>%
  kable(digits = 2,
        col.names = c("Item", "A (original)", "B (original)", 
                      "A (linked)", "B (linked)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center")

```

```{r}
foo <- mdas.par.dich %>%
  mutate(fl.param = item,
         t.param = paste0(item, "$1"),
         fl.parH = "f.by",
         t.parH = "thresholds") %>%
  select(fl.parH, fl.param, fl.l.mdas, t.parH, t.param, t.l.mdas)

foo.fl <- foo[,1:3]
foo.t <- foo[,4:6]
colnames(foo.fl) <- c("paramHeader", "param", "est")
colnames(foo.t) <- c("paramHeader", "param", "est")

goo <- rbind(foo.fl, foo.t)

myParam <- data.frame(f1s = 0)
for (i in 1:dim(goo)[1]) {
  if (goo$paramHeader[i]=="f.by") {
    myParam[[paste0("f",i, "s")]] = paste0(gsub("\\.", " ", 
                                                goo$paramHeader[i]), " ",
                                          goo$param[i], 
                                          "@", goo$est[i])
  }
  if (goo$paramHeader[i]=="thresholds") {
    myParam[[paste0("f",i, "s")]] = paste0("[", goo$param[i], 
                                           "@", goo$est[i],"]")
  }
  if (goo$paramHeader[i]=="variances") {
    myParam[[paste0("f",i, "s")]] = paste0(goo$param[i], 
                                           "@", goo$est[i])
  }
}

hoo <- paste(paste0("[[f", 1:dim(goo)[1], "s]];"), collapse = " \n ")
model.linked.mdas <- loopReplace(hoo, myParam)

cfa.mdas.link.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=logit; type=complex;",
  VARIABLE = "cluster = recordid; CATEGORICAL ARE all;",
  MODEL = model.linked.mdas,
  OUTPUT = "",
  SAVEDATA = "save = fscores; file = fscores-mdas-linked.dat;",
  usevariables = c("recordid", "rmdas01", "rmdas02", "rmdas03", 
                   "rmdas04", "rmdas05", "rmdas06", "rmdas07", 
                   "rmdas08", "rmdas09", "rmdas10"),
  rdata = basil2)
cfa.mdas.link.fit <- mplusModeler(cfa.mdas.link.body, 
                               modelout = "cfa-mdas-link.inp", run = TRUE)

  
```

```{r}
par.drs.cam <- full_join(drs.par.dich, cam.par.dich, by = "itemnum") %>%
  select(A.drs, B.drs, C.drs, A.cam, B.cam, C.cam)

comitems <- c(1, 2, 7, 8, 9, 10)
link.drs.cam <- irt.link(par.drs.cam, comitems, model = "3PL", 
         icc = "logistic", D = 1.7)  

A.link.cam <- link.drs.cam$Haebara[1]
B.link.cam <- link.drs.cam$Haebara[2]

cam.par.dich <- cam.par.dich %>%
  mutate(A.l.cam = A.link.cam*A.cam,
         B.l.cam = (B.cam - B.link.cam)/A.link.cam,
         fl.l.cam = A.l.cam,
         t.l.cam = B.l.cam*fl.l.cam)
```

### CAM-S item parameters linked

```{r}
cam.par.dich %>%
  select(item, A.cam, B.cam, A.l.cam, B.l.cam) %>%
  kable(digits = 2,
        col.names = c("Item", "A (original)", "B (original)", 
                      "A (linked)", "B (linked)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = F, position = "center")

```

```{r}
foo <- cam.par.dich %>%
  mutate(fl.param = item,
         t.param = paste0(item, "$1"),
         fl.parH = "f.by",
         t.parH = "thresholds") %>%
  select(fl.parH, fl.param, fl.l.cam, t.parH, t.param, t.l.cam)

foo.fl <- foo[,1:3]
foo.t <- foo[,4:6]
colnames(foo.fl) <- c("paramHeader", "param", "est")
colnames(foo.t) <- c("paramHeader", "param", "est")

goo <- rbind(foo.fl, foo.t)

myParam <- data.frame(f1s = 0)
for (i in 1:dim(goo)[1]) {
  if (goo$paramHeader[i]=="f.by") {
    myParam[[paste0("f",i, "s")]] = paste0(gsub("\\.", " ", 
                                                goo$paramHeader[i]), " ",
                                          goo$param[i], 
                                          "@", goo$est[i])
  }
  if (goo$paramHeader[i]=="thresholds") {
    myParam[[paste0("f",i, "s")]] = paste0("[", goo$param[i], 
                                           "@", goo$est[i],"]")
  }
  if (goo$paramHeader[i]=="variances") {
    myParam[[paste0("f",i, "s")]] = paste0(goo$param[i], 
                                           "@", goo$est[i])
  }
}

hoo <- paste(paste0("[[f", 1:dim(goo)[1], "s]];"), collapse = " \n ")
model.linked.cam <- loopReplace(hoo, myParam)

cfa.cam.link.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=logit; type=complex;",
  VARIABLE = "cluster = recordid; CATEGORICAL ARE all;",
  MODEL = model.linked.cam,
  OUTPUT = "",
  SAVEDATA = "save = fscores; file = fscores-cam-linked.dat;",
  usevariables = c("recordid", "rcamlf1a", "rcamlf2a", "rcamlf3a", 
                   "rcamlf4a", "rcamlf5a",
                   "rcamlf6a", "rcamlf7a", "rcamlf8a", "rcamlf8d",   
                   "rcamlf9a"),
  rdata = basil2)
cfa.cam.link.fit <- mplusModeler(cfa.cam.link.body, 
                               modelout = "cfa-cam-link.inp", run = TRUE)




```




