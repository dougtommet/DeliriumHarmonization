
Running the CFA using WLSMV produced many warning messages about variables being highly correlated and/or having a zero cell in two way table.  Most of these were due to having the same feature assessed across multiple instruments and logical dependencies (psychomotor aggitation/retardation).

These are the item pairs that produced the warnings.
```{r}

# accute onset - delusions
with(basil, table(rcamlf1a, rdrs03))
with(basil, table(rcamlf1a, rmdas08))
# inattention
with(basil, table(rcamlf2a, rdrs10))
#disorganized thinking
with(basil, table(rcamlf3a, rmdas06))
# disorientatation
with(basil, table(rcamlf5a, rmdas02))
# perceptual disturbance - psychomotor
with(basil, table(rcamlf7a, rdrs08))
with(basil, table(rcamlf8d, rcamlf7a))
# delusions
with(basil, table(rmdas08, rdrs03))
# perceptual disturbance
with(basil, table(rmdas07, rdrs02))
with(basil, table(rcamlf7a, rdrs02))
with(basil, table(rcamlf7a, rmdas07))
# psychomotor agitation/retardation
with(basil, table(rmdas09, rdrs08))
with(basil, table(rdrs08, rdrs07))
with(basil, table(rcamlf8a, rdrs07))
with(basil, table(rcamlf8a, rdrs08))
with(basil, table(rcamlf8a, rmdas09))
with(basil, table(rcamlf8d, rdrs07))
with(basil, table(rcamlf8d, rdrs08))
with(basil, table(rcamlf8d, rcamlf8a))
# memory
with(basil, table(rmdas03, rdrs11))
with(basil, table(rcamlf6a, rdrs11))
with(basil, table(rcamlf6a, rmdas03))
# sleep/wake
with(basil, table(rmdas10, rdrs01))
with(basil, table(rcamlf9a, rdrs01))
with(basil, table(rcamlf9a, rmdas10))


```

Fit a cfa model with mlr-probit
```{r}

varlist <- c("rdrs01", "rdrs02", "rdrs03", 
                   "rdrs04", "rdrs05", "rdrs06", "rdrs07", "rdrs08", 
                   "rdrs09", "rdrs10", "rdrs11", "rdrs12", "rdrs13",
                   "rmdas01", "rmdas02", "rmdas03", "rmdas04", "rmdas05", 
                   "rmdas06", "rmdas07", "rmdas08", "rmdas09", "rmdas10",
                   "rcamlf1a", "rcamlf2a", "rcamlf3a", "rcamlf4a", "rcamlf5a",
                   "rcamlf6a", "rcamlf7a", "rcamlf8a", "rcamlf8d",   
                   "rcamlf9a")

varlist.collapsed<- paste0(varlist, collapse = " ")

varlist.model <- varlist %>%
  paste0(., collapse = " \n ") %>%
  gsub("rdrs01", "rdrs01*", .)

model.1 <- paste("f by", varlist.model, ";", "f@1;")


cfa.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=probit;",
  VARIABLE = "idvariable = recordid; CATEGORICAL ARE all;",
  MODEL = model.1,
  OUTPUT = "",
  SAVEDATA = "",
  usevariables = c("recordid", varlist),
  rdata = basil
)
cfa.fit <- mplusModeler(cfa.body, modelout = "cfa001.inp", run = TRUE)


```
After fitting a cfa with mlr-probit still having an issue between these two items.
```{r}
#disorganized thinking
with(basil, table(rcamlf3a, rmdas06))
```
Removing MDAS 06 - Disorganized thing
```{r}

varlist.2 <- varlist[!varlist %in% c("rmdas06")]
varlist.2.model <- varlist.2 %>%
  paste0(., collapse = " \n ") %>%
  gsub("rdrs01", "rdrs01*", .)

model.2 <- paste("f by", varlist.2.model, ";", "f@1;")

cfa.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=probit;",
  VARIABLE = "idvariable = recordid; CATEGORICAL ARE all;",
  MODEL = model.2,
  OUTPUT = "",
  SAVEDATA = "",
  usevariables = c("recordid", varlist.2),
  rdata = basil
)
cfa.fit <- mplusModeler(cfa.body, modelout = "cfa002.inp", run = TRUE)


```
There is now an issue between these two items
```{r}
# memory
with(basil, table(rmdas03, rdrs11))
```
Removing DRS 11 - Memory from model
```{r}

varlist.3 <- varlist.2[!varlist.2 %in% c("rdrs11")]
varlist.3.model <- varlist.3 %>%
  paste0(., collapse = " \n ") %>%
  gsub("rdrs01", "rdrs01*", .)
varlist.3.collapsed<- paste0(varlist.3, collapse = " \n ")
model.3 <- paste("f by", varlist.3.model, ";", "f@1;")

cfa.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=probit;",
  VARIABLE = "idvariable = recordid; CATEGORICAL ARE all;",
  MODEL = model.3,
  OUTPUT = "",
  SAVEDATA = "",
  usevariables = c("recordid", varlist.3),
  rdata = basil
)
cfa.fit <- mplusModeler(cfa.body, modelout = "cfa003.inp", run = TRUE)


```
Removing CAM 2A - Inattention from model
```{r}

varlist.4 <- varlist.3[!varlist.3 %in% c("rcamlf2a")]
varlist.4.model <- varlist.4 %>%
  paste0(., collapse = " \n ") %>%
  gsub("rdrs01", "rdrs01*", .)
varlist.4.collapsed<- paste0(varlist.4, collapse = " \n ")
model.4 <- paste("f by", varlist.4.model, ";", "f@1;")

cfa.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=probit;",
  VARIABLE = "idvariable = recordid; CATEGORICAL ARE all;",
  MODEL = model.4,
  OUTPUT = "svalues;",
  SAVEDATA = "",
  usevariables = c("recordid", varlist.4),
  rdata = basil
)
cfa.fit <- mplusModeler(cfa.body, modelout = "cfa004.inp", run = TRUE)
foo<-readModels("cfa004.out")

```

Get the parameter estimates to use in the monte carlo model.
```{r}

param <- extractModelParameters("cfa004.out")$unstandardized
mc.param <- param %>%
  filter(paramHeader=="F.BY" | 
         paramHeader=="Thresholds" |
         (paramHeader=="Variances" & param=="F")) %>%
  mutate(est = as.numeric(est)) %>%
  mutate_each(funs(tolower))
  
mc.param <- unique(mc.param[,1:3])



```

```{r}
loopReplace <- function(text, replacements) {
  for (v in names(replacements)) {
    text <- gsub(sprintf("\\[\\[%s\\]\\]", v), replacements[[v]], text)
  }
  return(text)
}

myParam <- data.frame(f1s = 0)
for (i in 1:dim(mc.param)[1]) {
  if (mc.param$paramHeader[i]=="f.by") {
    myParam[[paste0("f",i, "s")]] = paste0(gsub("\\.", " ", 
                                                mc.param$paramHeader[i]), " ",
                                          mc.param$param[i], 
                                          "@", mc.param$est[i])
  }
  if (mc.param$paramHeader[i]=="thresholds") {
    myParam[[paste0("f",i, "s")]] = paste0("[", mc.param$param[i], 
                                           "@", mc.param$est[i],"]")
  }
  if (mc.param$paramHeader[i]=="variances") {
    myParam[[paste0("f",i, "s")]] = paste0(mc.param$param[i], 
                                           "@", mc.param$est[i])
  }
}

goo <- paste(paste0("[[f", 1:dim(mc.param)[1], "s]];"), collapse = " \n ")
foo <- loopReplace(goo, myParam)

# Even though we are generating data and not using data, we still need a data frame to be listed to pass an internal check.

objs <- mplusObject(
    TITLE = "",
    ANALYSIS = paste("estimator = mlr; link=probit; 
    montecarlo: names are",  varlist.4.collapsed, ";
      categorical = all;
      nobs = 10000;
      nreps = 1;
      save = mc-data.dat;
      seed = 12345;
      generate = ", varlist.4.collapsed, "(1 p);
    model population:", foo),
    MODEL = model.4,
    rdata =  basil
      )
models <- mplusModeler(objs, modelout = "mc_cfa.inp", run = TRUE, 
                       havedatastatement=FALSE, havevarstatement = FALSE)

mc.data <- getSavedata_Data("mc_cfa.out") 
colnames(mc.data) <- tolower(names(mc.data))  


```

```{r}


cfa.body <- mplusObject(
  ANALYSIS = "estimator = wlsmv; parameterization = theta;",
  VARIABLE = "CATEGORICAL ARE all;",
  MODEL = model.4,
  OUTPUT = "",
  SAVEDATA = "",
  usevariables = c(varlist.4),
  rdata = mc.data
)
cfa.wls.fit <- mplusModeler(cfa.body, modelout = "cfa004wls.inp", run = TRUE)

cfa.body <- mplusObject(
  ANALYSIS = "estimator = mlr; link=probit;",
  VARIABLE = "CATEGORICAL ARE all;",
  MODEL = model.4,
  OUTPUT = "",
  SAVEDATA = "",
  usevariables = c(varlist.4),
  rdata = mc.data
)
cfa.mlr.fit <- mplusModeler(cfa.body, modelout = "cfa004mlr.inp", run = TRUE)


extractModelSummaries() %>%
  filter(Estimator=="WLSMV") %>%
  select(CFI, RMSEA_Estimate) %>%
  kable()


```





